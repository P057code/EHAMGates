<?php

class Callsigns_EHAM {
	private static $extraCallsignsFile = 'data-callsigns.txt';
	private static $retention = 900; // 15 minutes

	// Formatted for Dutch Planespotters (hence EZY => EZY, not EZY => U2)
	private static $known2014 = array(
		// KLM
		'KLM10B' => 'KL 1210',
		'KLM10M' => 'KL 1208',
		'KLM11B' => 'KL 1127',
		'KLM11M' => 'KL 1705',
		'KLM11P' => 'KL 1227',
		'KLM11Y' => 'KL 1157',
		'KLM12H' => 'KL 1704',
		'KLM12P' => 'KL 1228',
		'KLM12V' => 'KL 1128',
		'KLM12Y' => 'KL 1158',
		'KLM13G' => 'KL 1129',
		'KLM13N' => 'KL 1059',
		'KLM13T' => 'KL 1703',
		'KLM13W' => 'KL 1811',
		'KLM14N' => 'KL 1060',
		'KLM14W' => 'KL 1812',
		'KLM14X' => 'KL 1130',
		'KLM14Y' => 'KL 1160',
		'KLM15E' => 'KL 1131',
		'KLM15L' => 'KL 1505',
		'KLM15P' => 'KL 1233',
		'KLM15S' => 'KL 1535',
		'KLM15X' => 'KL 1537',
		'KLM16L' => 'KL 1506',
		'KLM16P' => 'KL 1234',
		'KLM16V' => 'KL 1132',
		'KLM16X' => 'KL 1530',
		'KLM17' => 'KL 0651',
		'KLM17C' => 'KL 1121',
		'KLM17G' => 'KL 1133',
		'KLM17M' => 'KL 1701',
		'KLM18' => 'KL 0652',
		'KLM18C' => 'KL 1702',
		'KLM18M' => 'KL 1146',
		'KLM18S' => 'KL 1882',
		'KLM18X' => 'KL 1134',
		'KLM18Y' => 'KL 1884',
		'KLM19B' => 'KL 1139',
		'KLM19J' => 'KL 1147',
		'KLM19M' => 'KL 1109',
		'KLM19P' => 'KL 1243',
		'KLM19T' => 'KL 1699',
		'KLM19U' => 'KL 1973',
		'KLM20H' => 'KL 1700',
		'KLM20M' => 'KL 1110',
		'KLM20P' => 'KL 1244',
		'KLM213' => 'KL 0681',
		'KLM214' => 'KL 0682',
		'KLM21J' => 'KL 1221',
		'KLM21L' => 'KL 1053',
		'KLM21U' => 'KL 1807',
		'KLM21V' => 'KL 1863',
		'KLM22J' => 'KL 1618',
		'KLM22L' => 'KL 1054',
		'KLM22T' => 'KL 1818',
		'KLM22U' => 'KL 1808',
		'KLM23' => 'KL 0661',
		'KLM23P' => 'KL 1223',
		'KLM23Y' => 'KL 1861',
		'KLM24' => 'KL 0662',
		'KLM24J' => 'KL 1862',
		'KLM24P' => 'KL 1224',
		'KLM24X' => 'KL 1624',
		'KLM255' => 'KL 0621',
		'KLM256' => 'KL 0622',
		'KLM25P' => 'KL 1245',
		'KLM25R' => 'KL 1423',
		'KLM26B' => 'KL 1582',
		'KLM26P' => 'KL 1246',
		'KLM26R' => 'KL 1424',
		'KLM27G' => 'KL 1903',
		'KLM27Y' => 'KL 1855',
		'KLM27Z' => 'KL 1217',
		'KLM281' => 'KL 0605',
		'KLM282' => 'KL 0606',
		'KLM28K' => 'KL 1340',
		'KLM28M' => 'KL 1904',
		'KLM28Z' => 'KL 1218',
		'KLM29L' => 'KL 1477',
		'KLM29T' => 'KL 1879',
		'KLM29W' => 'KL 0963',
		'KLM29Y' => 'KL 1857',
		'KLM30K' => 'KL 1342',
		'KLM30W' => 'KL 0964',
		'KLM30Y' => 'KL 1858',
		'KLM31' => 'KL 0691',
		'KLM32' => 'KL 0692',
		'KLM32D' => 'KL 1148',
		'KLM32S' => 'KL 1344',
		'KLM32W' => 'KL 1440',
		'KLM33G' => 'KL 1441',
		'KLM33H' => 'KL 1623',
		'KLM33J' => 'KL 1193',
		'KLM33N' => 'KL 1345',
		'KLM34G' => 'KL 1442',
		'KLM34K' => 'KL 1346',
		'KLM34Z' => 'KL 1852',
		'KLM35E' => 'KL 1171',
		'KLM35T' => 'KL 1753',
		'KLM35W' => 'KL 1347',
		'KLM36L' => 'KL 1736',
		'KLM36S' => 'KL 1348',
		'KLM37A' => 'KL 1419',
		'KLM37G' => 'KL 1445',
		'KLM37P' => 'KL 1229',
		'KLM37Y' => 'KL 1883',
		'KLM38G' => 'KL 1446',
		'KLM38H' => 'KL 1650',
		'KLM38P' => 'KL 1230',
		'KLM39B' => 'KL 1653',
		'KLM39E' => 'KL 1169',
		'KLM39N' => 'KL 1349',
		'KLM39Z' => 'KL 1443',
		'KLM40B' => 'KL 1654',
		'KLM40E' => 'KL 1170',
		'KLM40M' => 'KL 1470',
		'KLM40Z' => 'KL 1444',
		'KLM41H' => 'KL 1969',
		'KLM41U' => 'KL 1267',
		'KLM42G' => 'KL 1478',
		'KLM42U' => 'KL 1268',
		'KLM43H' => 'KL 1327',
		'KLM43M' => 'KL 1473',
		'KLM43Z' => 'KL 1163',
		'KLM44A' => 'KL 1708',
		'KLM44M' => 'KL 1474',
		'KLM45C' => 'KL 1791',
		'KLM45F' => 'KL 1343',
		'KLM45J' => 'KL 1475',
		'KLM46C' => 'KL 1792',
		'KLM46F' => 'KL 1476',
		'KLM47' => 'KL 0611',
		'KLM47B' => 'KL 1953',
		'KLM47V' => 'KL 1793',
		'KLM48' => 'KL 0612',
		'KLM48B' => 'KL 1954',
		'KLM48V' => 'KL 1794',
		'KLM48Y' => 'KL 1924',
		'KLM49C' => 'KL 1797',
		'KLM49J' => 'KL 1481',
		'KLM49L' => 'KL 1959',
		'KLM49W' => 'KL 1925',
		'KLM50C' => 'KL 1798',
		'KLM50G' => 'KL 1952',
		'KLM50L' => 'KL 1960',
		'KLM50V' => 'KL 1926',
		'KLM51R' => 'KL 1063',
		'KLM51T' => 'KL 1835',
		'KLM51X' => 'KL 1825',
		'KLM51Y' => 'KL 1927',
		'KLM52F' => 'KL 1362',
		'KLM52R' => 'KL 1064',
		'KLM52X' => 'KL 1826',
		'KLM52Y' => 'KL 1928',
		'KLM53L' => 'KL 1201',
		'KLM53M' => 'KL 1931',
		'KLM53W' => 'KL 1363',
		'KLM54M' => 'KL 1932',
		'KLM54W' => 'KL 1364',
		'KLM55T' => 'KL 1355',
		'KLM56B' => 'KL 1156',
		'KLM56L' => 'KL 1962',
		'KLM56T' => 'KL 1356',
		'KLM57C' => 'KL 1957',
		'KLM57M' => 'KL 1211',
		'KLM57W' => 'KL 1933',
		'KLM58C' => 'KL 1958',
		'KLM58H' => 'KL 1880',
		'KLM58R' => 'KL 1372',
		'KLM58V' => 'KL 1934',
		'KLM59Z' => 'KL 1937',
		'KLM61R' => 'KL 1375',
		'KLM62R' => 'KL 1376',
		'KLM63L' => 'KL 1635',
		'KLM63T' => 'KL 1313',
		'KLM65F' => 'KL 1365',
		'KLM65G' => 'KL 1449',
		'KLM65L' => 'KL 1601',
		'KLM66F' => 'KL 1366',
		'KLM67S' => 'KL 1891',
		'KLM67Z' => 'KL 1603',
		'KLM68Z' => 'KL 1604',
		'KLM69J' => 'KL 1887',
		'KLM69M' => 'KL 1609',
		'KLM69W' => 'KL 1551',
		'KLM70J' => 'KL 1888',
		'KLM71H' => 'KL 1117',
		'KLM71K' => 'KL 1175',
		'KLM73J' => 'KL 1677',
		'KLM73N' => 'KL 1311',
		'KLM74G' => 'KL 1174',
		'KLM74N' => 'KL 1312',
		'KLM74S' => 'KL 1692',
		'KLM75K' => 'KL 1675',
		'KLM76T' => 'KL 1676',
		'KLM77C' => 'KL 1911',
		'KLM77M' => 'KL 1435',
		'KLM78C' => 'KL 1912',
		'KLM78E' => 'KL 1540',
		'KLM79F' => 'KL 1431',
		'KLM79G' => 'KL 1379',
		'KLM79K' => 'KL 1673',
		'KLM79X' => 'KL 1125',
		'KLM80L' => 'KL 1432',
		'KLM80T' => 'KL 1674',
		'KLM80X' => 'KL 1126',
		'KLM81J' => 'KL 1429',
		'KLM81V' => 'KL 1777',
		'KLM82J' => 'KL 1430',
		'KLM82V' => 'KL 1778',
		'KLM83F' => 'KL 1421',
		'KLM83K' => 'KL 1671',
		'KLM83R' => 'KL 1875',
		'KLM84F' => 'KL 1422',
		'KLM84R' => 'KL 1876',
		'KLM85J' => 'KL 1665',
		'KLM86N' => 'KL 1666',
		'KLM87B' => 'KL 1779',
		'KLM88B' => 'KL 1780',
		'KLM88J' => 'KL 1776',
		'KLM88T' => 'KL 1664',
		'KLM89S' => 'KL 1081',
		'KLM90J' => 'KL 1420',
		'KLM90K' => 'KL 1672',
		'KLM90S' => 'KL 1082',
		'KLM91Z' => 'KL 1097',
		'KLM92Z' => 'KL 1072',
		'KLM93V' => 'KL 1781',
		'KLM94G' => 'KL 1782',
		'KLM95T' => 'KL 1303',
		'KLM95X' => 'KL 1783',
		'KLM96B' => 'KL 1784',
		'KLM96H' => 'KL 1304',
		'KLM96L' => 'KL 1796',
		'KLM98C' => 'KL 1300',
		'KLM98M' => 'KL 1644',
		'KLM99X' => 'KL 1789',
		'KLM15W' => 'KL 1535',

		// Air France
		'AFR421E' => 'AF 1240',
		'AFR131E' => 'AF 1341',
		'AFR461H' => 'AF 1640',
		'AFR146F' => 'AF 1641',
		'AFR261B' => 'AF 1692',
		'AFR471N' => 'AF 1740',
		'AFR179L' => 'AF 1792',
		'AFR580D' => 'AF 1893',
		'AFR403D' => 'AF 4304',
		'AFR504G' => 'AF 4305',
		'AFR031C' => 'AF 4313',

		// CityJet
		'BCY80C' => 'AF 3166',
		'BCY81W' => 'AF 3167',
		'BCY82L' => 'AF 3168',
		'BCY83N' => 'AF 3169',
		'BCY84V' => 'AF 3170',
		'BCY85M' => 'AF 3171',
		'BCY86U' => 'AF 3172',
		'BCY87C' => 'AF 3173',
		'BCY88L' => 'AF 3174',
		'BCY92N' => 'AF 3174',
		'BCY93G' => 'AF 3176',
		'BCY94T' => 'AF 3177',
		'BCY95J' => 'AF 3178',
		'BCY96X' => 'AF 3179',
		'BCY197' => 'AF 3180',
		'BCY98K' => 'AF 3181',
		'BCY99E' => 'AF 3182',
	
		// FlyBe
		'BEE5JY' => 'BE 101',
		'BEE6BV' => 'BE 102',
		'BEE9NV' => 'BE 103',
		'BEE9DN' => 'BE 104',
		'BEE3JL' => 'BE 105',
		'BEE4UF' => 'BE 106',
		'BEE1PE' => 'BE 1011',
		'BEE8EL' => 'BE 1012',
		'BEE1VL' => 'BE 1013',
		'BEE8NG' => 'BE 1014',
		'BEE3VX' => 'BE 1015',
		'BEE3CJ' => 'BE 1016',
		'BEE5EZ' => 'BE 1017',
		'BEE7RA' => 'BE 1018',
		'BEE2GA' => 'BE 1095',
		'BEE7DR' => 'BE 1096',
		'BEE7TF' => 'BE 1285',
		'BEE3FU' => 'BE 1286',
		'BEE7EH' => 'BE 1533',
		'BEE3MP' => 'BE 1534',
	
		// CityFlyer Express
		'CFE67N' => 'BA 8450',
		'CFE99V' => 'BA 8451',
		'CFE60X' => 'BA 8454',
		'CFE31U' => 'BA 8455',
		'CFE18A' => 'BA 8456',
		'CFE19R' => 'BA 8457',
		'CFE88C' => 'BA 8458',
		'CFE33Q' => 'BA 8459',
		'CFE26F' => 'BA 8497',

		// Lufthansa
		'DLH4A'  => 'LH 987',
		'DLH5CT' => 'LH 988',
		'DLH8A'  => 'LH 989',
		'DLH1A'  => 'LH 991',
		'DLH7KW' => 'LH 992',
		'DLH3A'  => 'LH 993',
		'DLH5YN' => 'LH 996',
		'DLH5A'  => 'LH 997',
		'DLH7A'  => 'LH 999',
		'DLH9CT' => 'LH 1002',
		'DLH2A'  => 'LH 1003',
		'DLH6AE' => 'LH 2300',
		'DLH6RJ' => 'LH 2301',
		'DLH9VY' => 'LH 2302',
		'DLH3CH' => 'LH 2303',
		'DLH1MJ' => 'LH 2304',
		'DLH1JW' => 'LH 2305',
		'DLH9KH' => 'LH 2306',
		'DLH6RP' => 'LH 2307',
		'DLH1VX' => 'LH 2308',
		'DLH6UV' => 'LH 2309',
		'DLH3LJ' => 'LH 2310',
		'DLH7YA' => 'LH 2311',

		// Jet2.com
		'EXS12ZN' => 'LS 201',
		'EXS64EG' => 'LS 205',

		// easyJet Switzerland
		'EZS65HR' => 'EZS 1042',
		'EZS92AL' => 'EZS 1044',
		'EZS21GR' => 'EZS 1045',
		'EZS72GM' => 'EZS 1046',
		'EZS46PN' => 'EZS 1353',
		'EZS13EY' => 'EZS 1354',
		'EZS11FD' => 'EZS 1355',
		'EZS74KJ' => 'EZS 1356',
		'EZS85TN' => 'EZS 1357',
		'EZS98YP' => 'EZS 1358',

		// easyJet
		'EZY36CL' => 'EZY 1355',
		'EZY61JK' => 'EZY 1356',
		'EZY16NG' => 'EZY 1831',
		'EZY71GX' => 'EZY 1832',
		'EZY19XG' => 'EZY 1833',
		'EZY58XD' => 'EZY 1834',
		'EZY52JH' => 'EZY 1836',
		'EZY59KC' => 'EZY 2155',
		'EZY44CL' => 'EZY 2156',
		'EZY54UJ' => 'EZY 2158',
		'EZY84YN' => 'EZY 2159',
		'EZY78JH' => 'EZY 2160',
		'EZY33GL' => 'EZY 2161',
		'EZY38CB' => 'EZY 2162',
		'EZY12FH' => 'EZY 2163',
		'EZY15LP' => 'EZY 2723',
		'EZY71EJ' => 'EZY 2724',
		'EZY89ML' => 'EZY 2725',
		'EZY11JX' => 'EZY 2726',
		'EZY33FJ' => 'EZY 2727',
		'EZY82NG' => 'EZY 2728',
		'EZY46FG' => 'EZY 2729',
		'EZY71YN' => 'EZY 2730',
		'EZY89GW' => 'EZY 3001',
		'EZY99MV' => 'EZY 3002',
		'EZY32DV' => 'EZY 3005',
		'EZY65VF' => 'EZY 3006',
		'EZY86RC' => 'EZY 3009',
		'EZY48KA' => 'EZY 3012',
		'EZY33CA' => 'EZY 3808',
		'EZY51MN' => 'EZY 4116',
		'EZY95MP' => 'EZY 4563',
		'EZY88AE' => 'EZY 4564',
		'EZY55JM' => 'EZY 4565',
		'EZY84AR' => 'EZY 4567',
		'EZY55RX' => 'EZY 4568',
		'EZY71HF' => 'EZY 4993',
		'EZY62BE' => 'EZY 4994',
		'EZY39ER' => 'EZY 4995',
		'EZY31FC' => 'EZY 4996',
		'EZY47WJ' => 'EZY 6161',
		'EZY77AX' => 'EZY 6162',
		'EZY56LB' => 'EZY 6167',
		'EZY16MJ' => 'EZY 6168',
		'EZY72NB' => 'EZY 6454',
		'EZY29VN' => 'EZY 6771',
		'EZY51UB' => 'EZY 6772',
		'EZY49LP' => 'EZY 6775',
		'EZY25LK' => 'EZY 6776',
		'EZY44NH' => 'EZY 6853',
		'EZY82KD' => 'EZY 6854',
		'EZY23XE' => 'EZY 6921',
		'EZY11EF' => 'EZY 6922',
		'EZY97VJ' => 'EZY 6923',
		'EZY14FD' => 'EZY 6924',
		'EZY21BR' => 'EZY 7001',
		'EZY65TF' => 'EZY 7002',
		'EZY41XU' => 'EZY 7007',
		'EZY72CL' => 'EZY 7008',
		'EZY82JL' => 'EZY 7011',
		'EZY65KD' => 'EZY 7012',
		'EZY45PU' => 'EZY 7401',
		'EZY21MN' => 'EZY 7402',
		'EZY88RM' => 'EZY 7404',
		'EZY97XG' => 'EZY 7406',
		'EZY71VN' => 'EZY 7409',
		'EZY68HC' => 'EZY 7664',
		'EZY99GP' => 'EZY 8869',
		'EZY29RJ' => 'EZY 8870',
		'EZY35YR' => 'EZY 8871',
		'EZY38MD' => 'EZY 8872',
		'EZY48YJ' => 'EZY 8873',
		'EZY74RW' => 'EZY 8874',
		'EZY47XH' => 'EZY 8875',
		'EZY59VP' => 'EZY 8876',
		'EZY23UT' => 'EZY 8877',
		'EZY22WP' => 'EZY 8878',
		'EZY11MA' => 'EZY 8881',
		'EZY31UR' => 'EZY 8882',
		'EZY15TM' => 'EZY 8883',

		// Germanwings
		'GWI01U' => '4U 7180',
		'GWI87H' => '4U 7181',
		'GWI14E' => '4U 7182',
		'GWI15H' => '4U 7183',
		'GWI37V' => '4U 7184',
		'GWI72Z' => '4U 7185',

		// Norwegian Air
		'NAX58U'  => 'DY 1258',
		'NAX9JL'  => 'DY 1259',
		'NAX54CA' => 'DY 3540',
		'NAX541B' => 'DY 3541',
		'NAX1NE'  => 'DY 4531',
		'NAX2YW'  => 'DY 4532',

		// Sun Express
		'SXS4RF' => 'XQ 722',
		'SXS8HU' => 'XQ 723',
		'SXS6ED' => 'XQ 944',
		'SXS2NE' => 'XQ 945',

		// Turkish Airlines
		'THY3PK' => 'TK 1951',
		'THY7CD' => 'TK 1952',
		'THY9TC' => 'TK 1953',
		'THY1PY' => 'TK 1954',
		'THY1SG' => 'TK 1955',
		'THY7HE' => 'TK 1956',
		'THY5VE' => 'TK 1957',
		'THY8FD' => 'TK 1958',
		'THY6ZC' => 'TK 1961',
		'THY63X' => 'TK 1962'
	);

	static function findFlightnumber($callsign) {
		$getFlightnumber = file_get_contents('http://planefinder.net/data/endpoints/search_ajax.php?searchText=' . $callsign);
		$getFlightnumber = json_decode($getFlightnumber, true);

		if($getFlightnumber) {
			foreach($getFlightnumber['flights'] as $data) {
				if($data['subtitle'] == $callsign) {
					return preg_replace('/^([A-Z0-9]{2})/', '$1 ', $data['title']);
				}
			}
		}

		return false;
	}

	static function getCallsignsFromFile() {
		$data = file_get_contents(self::$extraCallsignsFile);
		$data = json_decode($data, true);

		return $data;
	}

	static function addFlightnumber($callsign, $flightnumber) {
		$data = self::getCallsignsFromFile();
		$data[$callsign]['flightnumber'] = $flightnumber;
		$data[$callsign]['added'] = time();

		file_put_contents(self::$extraCallsignsFile, json_encode($data));

		return $data[$callsign];
	}

	static function convertAlphanumeric($callsign) {
		$defaultCallsigns = self::$known2014;
		$storedCallsigns = self::getCallsignsFromFile();

		if(array_key_exists($callsign, $defaultCallsigns)) {
			return $defaultCallsigns[$callsign];
		}

		if(array_key_exists($callsign, $storedCallsigns)) {
			$data = $storedCallsigns[$callsign];

			if($data['added'] + self::$retention < time()) {
				$findRemote = self::findFlightnumber($callsign);

				if($findRemote) {
					$data = self::addFlightnumber($callsign, $findRemote);
				}
				else {
					$data = self::addFlightnumber($callsign, $data['flightnumber']);
				}
			}

			return $data['flightnumber'];
		}
		
		$findRemote = self::findFlightnumber($callsign);
		self::addFlightnumber($callsign, $findRemote);
		
		return $findRemote;
	}
}